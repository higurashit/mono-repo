# 移行ツール設計書

## 1. 前提条件
- AWS Step Functionsを使用して全体のフローを制御する。
- 各処理はPythonで記述されたAWS Lambda関数として実装する。
- 入力データは複数シートを持つ移行定義Excelファイルと、複数の移行元データCSVファイルとして提供される。
- 出力データは移行先マスタごとにExcelファイルとしてS3に保存する。
- チェック処理が終わった後、手動承認を挟む。
- 個別の加工要件はマージ処理の中に実装する。

## 2. ツール概要
移行ツールは、複数のCSVファイルから移行データを作成する。
AWS Step Functionsを用いて全体のフローを制御し、必要に応じて並列処理 (Map state) を活用する。
Step Functionは以下のノードとする。
- 元データリストの取得ノード (Lambda)
- Prallel
  - Map: 元データリスト
    - 移行元データの存在チェック (Step Functions) 
    - 移行元データのデータチェック (Lambda) 
  - 移行定義ファイルのチェックノード (Lambda)
- Map: ループ用移行定義リスト
  - 移行データのマージ (Lambda)
  - ループ判定 (Step Functions) 
  - 移行データの出力形式への加工 (Lambda) 


## 3. ツール処理詳細

### 3-1. 元データリストの取得ノード (Lambda)
#### 3-1-1. 入力
- 移行定義ファイルのパス
- 実行対象のシート名 (省略時は全シート) 

#### 3-1-2. 処理
1. 移行定義ファイルを読み込み、以下を確認する：
    - 移行定義ファイルが存在するか。
    - 移行対象が存在するか。
    - フォーマットエラーのシートがないか。
        - 元ファイル名が空。
        - 元データに空の項目名、型、桁がある。
1. 移行定義ファイルから以下を生成：
    - 移行元データリスト
        - ファイルパス

#### 3-1-3. 出力
- 移行元データリスト(JSON)

### 3-2. 移行元データの存在チェック (Step Functions - Map: 元データリスト) 
#### 3-2-1. 入力
- 移行元データリストの1要素

#### 3-2-2. 処理
- 移行元ファイルパスのファイルを取得 (GetObjectタスク) 
- ファイルが存在しない場合はエラーとする

#### 3-2-3. 出力
- なし

### 3-3. 移行元データのデータチェック (Lambda - Map: 元データリスト) 
#### 3-3-1. 入力
- 移行元データリストの1要素(ファイルパス)
- 移行定義リストのS3パス

#### 3-3-2. 処理
- ファイルパスを元に移行元ファイルをS3から取得する
- 移行定義リストをS3から取得する
- 移行定義リストの移行元データファイルリストから、ファイルパスをキーに以下を取得する
  - キー項目
  - データ項目ディクショナリ
- 移行元データの各項目でループし、以下をチェックする
  - キー項目が空のデータが存在しないこと
  - 型、桁、許容値に収まるデータであること
  - エラーがある場合はエラー配列にエラー内容を格納する
  - エラー配列が100件を超えたらループを抜ける
- 移行元データの件数を取得する
- エラー配列が1件以上の場合、エラー終了とする

#### 3-3-3. 出力
- 移行元データリストの1要素(ファイルパス)
- 件数
- エラー配列


### 3-4. 移行定義ファイルのチェックノード (Lambda) 
#### 3-4-1. 入力
- 移行定義ファイルのパス
- 実行対象のシート名 (省略時は全シート) 

#### 3-4-2. 処理
1. 移行定義ファイルを読み込み、以下を確認する：
    - 移行定義ファイルが存在するか。
    - 移行対象が存在するか。
    - フォーマットエラーのシートがないか。
        - 元先ファイル名が空。
        - 元先データ空の項目名、型、桁がある。
        - 必須項目 (NN) なのに初期値がない (Infoのみ) 。
        - 出力シート名と出力列名のどちらかが空。
1. 移行定義ファイルから以下を生成：
    - 移行元データリスト
        - ファイルパス
    - 移行定義リスト
        - 移行先データ
          - ファイルパス
          - キー項目
          - 項目ディクショナリ
              - 項目名、型、桁、NotNull、許容値
              - Excel出力先配列
                - シート名、列数
        - 移行元データリスト
            - ファイルパス
            - キー項目
            - 項目ディクショナリ
              - 項目名、型、桁、許容値、加工要件ありフラグ
1. 移行定義リストをS3にアップロードする
1. 移行定義リストの添字をループ用移行定義リストに設定する

#### 3-4-3. 出力
- ループ用移行定義リスト

### 3-5. 移行データのマージ (Lambda - Map: ループ用移行定義リスト) 
#### 3-5-1. 入力
- ループ用移行定義リストの1要素
- ループ回数 (初期値:0)

#### 3-5-2. 処理
1. 移行定義リストをS3から取得し、対象の移行定義 (添字から取得) を取得する
1. 移行元データリストを取り出す
1. 元データの取得
    - 初回実行時は空配列とする。   
    - 2回目以降はでS3に保存された前回結果データ (移行先ファイル名.csv) を対象とする。
1. マージデータの取得
    - 元データファイルリストの **ループ回数** 番目を対象データとする。
1. 統合キーリストの生成
    - 元データとマージデータのキーをマージして統合キーリストとする。
1. 初期レコードの定義
    - 移行先データ.項目ディクショナリ (初期値込み) を初期レコードとする
1. 統合キーリストを対象に、以下をループ実行する。
    - 統合キーから元データ、マージデータを1レコード分取得する
    - 結果レコードを初期レコードで生成する
    - 元データが存在する場合
        - 結果レコードに元データを設定する
    - マージデータが存在する場合
        - マージデータの加工処理 (個別実装) を行う
        - 結果レコードをマージデータで上書きする
    - 結果レコードの各項目でループし、以下をチェックする
        - 型、桁、許容値に収まるデータであること
        - エラーがある場合はエラー配列にエラー内容を格納する
        - エラー配列が100件を超えたらループを抜ける
    - マージ結果データに結果レコードを追加する
    - エラー配列が100件を超えたらループを抜ける
1. 継続フラグを設定する
    - 継続フラグをfalseに設定する
    - ループ回数 < 元データファイルリストの件数 - 1 の場合
        - 継続フラグをtrueに設定する
1. 継続フラグがfalseの場合
    - マージ結果データを1件ずつ取り出し、ループ実行する
      - 各レコードの各項目でループ実行する
        - 移行先データ.項目ディクショナリのNotNullがONかつ、項目値がNullの場合
          - エラー配列にエラー内容を格納する
          - エラー配列が100件を超えたらループを抜ける
      - エラー配列が100件を超えたらループを抜ける
1. マージ結果データを移行先ファイル名.csvでS3にアップロードする
1. エラー配列が1件以上の場合、エラー終了とする
1. ループ回数にループ回数 + 1 を格納する

#### 3-5-3. 出力
- マージ結果データ
- 継続フラグ
- ループ回数

### 3-6. ループ判定 (Step Functions - Map: ループ用移行定義リスト) 
#### 3-6-1. 入力
- 継続フラグ

#### 3-6-2. 処理
- 継続フラグがtrueの場合
  - 3-5. 移行データのマージ　に遷移する
- 継続フラグがfalseの場合
  - 3-5. 移行データのマージ　に遷移する

#### 3-6-3. 出力
- なし

### 3-7. 移行データのJMDM出力形式への加工 (Lambda - Map: ループ用移行定義リスト)
#### 3-7-1. 入力
- 移行定義リストの1要素

#### 3-7-2. 処理
1. S3に保存されたマージ済データ (移行先ファイル名.csv) を取得する。
1. Excel出力用配列を作成する
  - 移行先データ.項目ディクショナリでループする
    - Excel出力用配列でループする
      - シート名の配列が存在しない場合
        - シート名の配列を作成する
      - シート名の配列の列数に項目を列丸ごとコピーする
1. 各配列をExcelシートとしてファイルを生成する
1. S3にアップロードする

#### 3-7-3. 出力
- なし
