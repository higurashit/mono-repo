# 差分比較ツール設計

## 1. 前提条件
- AWS Step Functions を用いた状態遷移ベースの差分比較ツール。
- 入力データは S3 に保存された比較定義ファイル、元ファイル、先ファイル。
- 出力データは比較結果を含む2シートの Excel ファイル。
- 差分は行レベルと列レベルで明示する。
- エラーが発生した場合、適切にログ出力を行う。

## 2. ツール概要
このツールは、2つのデータファイル間の差分を比較するために以下の機能を提供します。
Step Functionは以下のノードとする。
- 比較定義ファイルの検証と比較リスト生成 (ノード1: Lambda)
- 元データの取得 (ノード2: Step Functions)
  - Map: 元データリスト
    - 移行元データの存在チェック (Step Functions) 
    - 移行元データのデータチェック (Lambda) 
  - 移行定義ファイルのチェックノード (Lambda)
- Map: ループ用移行定義リスト
  - 移行データのマージ (Lambda)
  - ループ判定 (Step Functions) 
  - 移行データの出力形式への加工 (Lambda) 

1. 比較定義ファイルを使用して、元データファイルと先データファイルの比較基準を定義。
2. 差分を行レベルおよび列レベルで検出。
3. 結果を出力用の Excel ファイルに整形。
4. 主要なステップにはエラーチェックを含む。

## 3. ツール処理詳細

### 3-1. 比較定義ファイルの検証と比較リスト生成 (ノード1: Lambda)
#### 3-1-1. 入力
- 比較定義ファイルのパス (S3 キー)
- 実行対象のシート名 (省略時は全シート)

#### 3-1-2. 処理
1. 比較定義ファイルを S3 から取得して読み込み。
2. 以下のチェックを実行：
   - 比較定義ファイルが存在するか。
   - 比較対象が存在するか。
   - フォーマットエラーのシートがないか。
     - 元ファイル名または先ファイル名が空。
     - 元データまたは先データに空の項目名や列数がある。
3. 比較定義ファイルから比較リストを生成
   - 元データシステム名
   - 先データシステム名
   - 元データファイルパス
   - 先データファイルパス
   - 元データおよび先データのキー列
   - 元データおよび先データの比較マッピング

#### 3-1-3. 出力
- 比較リスト (JSON)

### 3-2. データキーの検証と統合 (Lambda - Map: 比較リスト) 
#### 3-2-1. 入力
- 比較リストの1要素 (=比較定義)

#### 3-2-2. 処理
1. 比較定義から元データファイル、先データファイルを取得
  - ファイルが存在しない場合、エラー終了
1. 元データおよび先データのキー列を検証
   - キー項目のいずれかが空の場合、エラー配列に追加
   - キーが重複している場合、エラー配列に追加
   - エラー配列の件数が100件以上の場合、その時点でログを出力しエラー終了
1. 全件検証後、エラー配列が1件でも存在する場合はログを出力しエラー終了。
1. 元データおよび先データのキーをマージして統合キーリストを生成
1. 各統合キーで以下をループ
   - A列変数: 差分なし、B列変数: 差分なしで初期化する
   - 元データにキーが存在し、先データにキーが存在しない場合
      - A列変数: 行差分あり、B列変数: <元システム名>のみ存在 を設定
      - 結果配列 (項目ごとFMT) に以下を格納する
        - データ: A列、B列、元データ項目1、先データ項目1、元データ項目2、先データ項目2、、、
        - 差分種別: すべて1
      - 結果配列 (データごとFMT) に以下を格納する
        - データ: A列、B列、元データ項目、先データ項目
        - 差分種別: すべて1
   - 元データにキーが存在せず、先データにキーが存在する場合
      - A列変数: 行差分あり、B列変数: <先システム名>のみ存在 を設定
      - 結果配列 (項目ごとFMT) に以下を格納する
        - データ: A列、B列、元データ項目1、先データ項目1、元データ項目2、先データ項目2、、、
        - 差分種別: すべて2
      - 結果配列 (データごとFMT) に以下を格納する
        - データ: A列、B列、元データ項目、先データ項目
        - 差分種別: すべて2
   - 両方のデータが存在する場合
      - 結果レコード (項目ごとFMT) と結果レコード (データごとFMT) を用意する
      - 項目ごとにループする
        - 差分種別配列にすべて0 (差分なし) を設定
        - 元項目と先項目間に差分がある場合
          - A列変数: 列差分あり、B列変数: 空白のみ を設定
          - 差分種別に3 (空白のみ) を設定
          - 互いをトリムした後に差分を比較する
            - A列変数: 列差分あり、B列変数: 差分あり を設定
            - 差分種別に4 (差分あり) を設定
      - 結果配列 (項目ごとFMT) に結果レコード (項目ごとFMT) を追加する
      - 結果配列 (データごとFMT) に結果レコード (データごとFMT) を追加する
1. 列ごとに差分なし比率を算出する
    - A列: 差分なしの件数 / 統合キー件数
    - B列: 差分なしの件数 / 統合キー件数
    - データ列: 差分種別0の件数 / 統合キー件数
1. 差分結果リストを基に2つのシートを生成：
   - シート1: 結果配列 (項目ごとFMT)
   - シート2: 結果配列 (データごとFMT)
   - 差分種別に応じて以下のフォントを適用する
      - 0 (差分なし): 文字色グレー
      - 1 (元データのみ): 背景黄色
      - 2 (先データのみ): 背景黄色
      - 3 (空白のみ) : 背景薄黄色
      - 4 (差分あり) : 背景黄色
1. 結果を Excel ファイルとして作成。
1. 作成したファイルを S3 にアップロード。

#### 3-2-3. 出力
- 比較結果ファイル (S3 パス)

---

