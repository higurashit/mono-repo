# AWS Summit Online のまとめ（9セッション）
こんにちは、日暮です。 <br>
AWS Summit Online が9/7~9/8(Web視聴は9/30まで)に開催されていました。<br>
私が見たセッションについてまとめましたので共有します。
まだ閲覧できるセッションもありますので、興味のある方は[こちら](https://resources.awscloud.com/aws-summit-online-japan-2020-on-demand)からどうぞ！

## 【基調講演】12min
- イノベーションが価値提供の鍵に
- クラウドの価値は「価値提供」に集中できること
- ソニーはVISION-Sのプラットフォーム（センサ、ビッグデータ、AI）をフルクラウドで実現
- 機械学習は S3 + SageMaker で誰でも使える状態

## 【Amazon Culture of Innovationとマイクロサービスアーキテクチャ】40min
- Amazonのイノベーション文化
  - 「徹底した顧客志向」
    - 顧客満足度以外の利点がある
    - 言語化されていない、顕在化されていない要望
    - "今後10年間に変わらないもの" をテクノロジーで進化させる
    - 開発前にプレスリリース、FAQ を作成する（顧客体験を明確・詳細化させる）
  - 「長期的思考」
    - 革新的なことを始めたいのであれば、周囲から誤解されることを厭わない
    - Kindle も AWS も最初は酷評されていた
    - シンプルな最終目的を長期的に追い続ける
      - 世界中の人に本を1分で届けるには？
      - 開発者の作業を阻害しないITインフラを
  - 「失敗を恐れず失敗から学ぶ」
    - 新しいことを始めるのであれば失敗は起きて当然
    - 失敗した原因、要因を文書にまとめて報告することが大事
    - 株主向け文書：「Amazonが失敗をしていない場合、長期的に危険な兆候」
    - 現時点の最大の失敗 "Fire Phone"と言われている
      - その失敗は AlexaやAmazon Echo に活かされている
    - 人事評価では「創意工夫のプロセスと、良かった点、良くなかった点」を重視
    - Two way door：「引き返し不可能な判断」は一般社員には訪れない
- Amazon はサービス全体でマイクロサービスアーキテクチャ（SOA）を採用
  - 一つのアプリケーションは単一の目的を持つ
  - HTTPS の API でのみ連携する
  - 密結合を防ぐ
    - 物理的に理解できる範囲を超えると、メンテナンスが困難に
    - 属人性が最大化されてしまう（＝変革できないシステム・組織に）
  - マイクロサービスは Two-Pizza Teams（7~10名）で作る
    - コンウェアの法則（アプリケーションは組織に依存する）
    - 他チームが利用するAPIを作る場合も「お客様」へのサービス提供となる
    - AWSでは190を超えるチームが存在
  - マイクロサービスは API とイベントドリブンによって構築する
  - マイクロサービスはアジャイルとの相性が良い
    - 組織分割、強力な権限移譲を行う
    - 各チームは適切な開発手法でアプリケーションを構築する
    - マイクロサービスをつなげた全体を見ると、アジャイル的に開発が行われている

## 【2つのDXによるデジタル変革の実現】32min
- 4/10はCTOの日、日本CTO協会は2020/4/10に「DX動向調査」を発表
  - [本番環境のクラウド利用率は6割を超える](https://cto-a.org/news/2020/04/10/1679/)
- DX Criteriaにおける「組織のパラダイムシフト」のポイント
  - 組織文化と「見えない」投資
    - 心理的安全性の確保に投資できるか？
  - タスク型ダイバーシティ
    - 色々なロールの人を一つの部屋に入れてカオスからイノベーションを
  - メリハリのあるIT戦略
    - システムのコントローラビリティを高める、Xaasの積極的利用
  - 組織学習とアンラーニング
    - 適切に学習し、適切に忘れる
  - 自己診断と市場比較
    - パラダイムシフトできたかを客観的に評価する

## 【新しい常識としてのクラウドコンプライアンス】28min
- 新しい技術（新しい常識）は競争や危機によって生じる
  - 仮想化
    - 物理管理（サーバ） → 論理管理（コンテナ）
  - クラウドサービス
   - IT所有（オンプレ） → IT利用（クラウド）
  - DevOps
    - インフラ・アプリの職務分離 → 協働
  - サーバレス
    - インフラ運用 → サービス運用
  - ゼロトラスト（何も信頼できない状態での防御）
    - 境界防御（NW） → コンポーネント単位での防御
- 新しい常識を阻害するものは「組織の説明責任の基礎としてのポリシー」
  - ポリシーはテクノロジーの変化をフォローしない
  - ポリシーは肥大化、形骸化する
- DX はポリシーの運用の柔軟性にかかっている
  - ポリシーを更新するサイクルの整備
  - ポリシーを運用する
- 責任共有モデル（AWS - NTTD - 顧客）
  - データ廃棄の例
    - AWS：物理的に破壊、インフラレベルでの分離
    - NTTD：ライフサイクル運用の実装
    - 顧客：説明責任、目的の明確化
- AWS Well-Architectedによるベストプラクティスの実践
  - IPA「PF変革手引書の概要」で優れた例として紹介
  - 5つの柱で構成されている
    - 運用上の優秀性
    - セキュリティ
    - 信頼性
    - パフォーマンス効率
    - コスト最適化

## 【モダンアプリケーションのためのアーキテクチャデザインパターンと実装】30min
- 12(Twelve) Factor App
  - クラウドネイティブアプリケーション開発の方法論
  - 良いアーキチェクチャとは？の解
- 疎結合・相互運用
  - API ファースト
    - ゲートウェイパターンの採用
    - ロールベースアクセス制御（○呼び出し元の役割　✖️呼び出し元IP）
    - ポリグロットパーシステンス：用件に合わせたデータストアの選択
      - Aurora, RDS, DynamoDB, ElastiCache, DocumentDB,,,
  - バックエンドサービス
  - ポートバインディング
  - 認証/認可
- 伸縮性・弾力性
  - 廃棄容易性・ステートレスプロセス・並行性
    - Lambda > Fargate(Serverless Container) > ECS/EKS > EC2
    - Lambdaが全てにおいて優秀
    - データストアの伸縮性・弾力性を確保する方法
      - コマンドクエリ責任分離：更新をDynamodB、参照をAuroraとする
      - イベントソーシング：イベントから最終的な状態（及び全ての時点の状態）を導き出す
      - イベントソーシングはKinesis or SQSで実現可能
  - ログ
    - イベントストリームとして集約するべき：CloudWatch
- モニタリング
  - テレメトリ
    - パフォーマンス・ビジネス分析データのモニタリングを行うべき：X-Ray
- 自動化・継続性
  - 1コードベース, 1アプリ
  - 依存関係管理
  - 設計, ビルド, リリース, 実行
    - CI/CDはモダンアプリケーションに必要不可欠
    - CodePipeline, CodeGuru, CloudFormation, SAM
  - 設定, クレデンシャル, コード
  - 環境一致
  - 管理プロセス
- 良いアーキテクチャはビジネスを見据えた広い視野とパターン選択のバランス感覚が重要（盲信はNG）

## 【AWSの継続的インテグレーション／デリバリー総まとめ！モダンアプリケーション構築のための CI / CD ベストプラクティス！】30min
- CI/CDを適切に行うことで付加価値を生まない重労働を減らす
- 付加価値を生むことに開発リソースを集中させる
- CI（継続的インテグレーション）
  - CodeBuildによるフルマネージドのCIの実現
  - 各ビルドは新規Dockerコンテナで実行されるためイミュータブル
- CD（継続的デプロイメント）
  - CodePipeline, CodeDeployによるCDサービス
  - コード変更（Git、S3、DockerImage）をトリガーにテスト、ビルド、デプロイが可能
  - スケジュール実行やWebhookをトリガーとする実行も可能
  - CodeDeployでのLambdaファンクションのリリース方法
    - 関数重み付けエイリアスを利用したトラフィックのシフト
      - カナリアデプロイ（Ex. 10分間だけ新verを10%、その後100%に切り替え）
      - リニアデプロイ（Ex. 10分間おきに新verへの割合を10%ずつ増やす）
      - SAMテンプレートのDeploymentPreferenceで設定が可能
  - CodeDeployでのECS（Dockerコンテナ）リリース
    - Blue／Greenデプロイ
    - Green（新ver）をプロビジョニングしておく
    - 検証用HookやCloudWatchEventをトリガーにBlueに自動で切り戻し
    - ECSのappspecで設定する（検証用HookはLambdaで作成する）
- Infrastructure as code へのCI/CD
  - 成果物の検証、環境の検証が必要
  - アプリケーション同様、CodePipelineで自動テスト、自動デプロイを行う
  - CloudFormation, SAMを利用する
    - pip install aws-sam-cli
  - Fageageの場合はCDKでモデル化することが可能（Node,Python,Java,C#でのIaC）
    - npm install aws-cdk

## 【Let’s dive deep into AWS Lambda error handling】30min
- Lambdaのエラーハンドリングについてのセッション
- Everything fails all the time（全てのものは故障する）
- Design for Failure（故障をデザインする）
- クラウドネイティブ時代では、データ整合性の確保や影響拡大防止は必須
- ビジネスインパクトと費用対効果のある対策を実施する
- ①不要なリトライの回避
  - 誰が、どれくらいの期間、頻度、何度リトライするのかを検討
  - 入力データ（イベントデータ）の退避先があるか、退避先がモニタリングされているか
  - Lambdaのリトライ制御はイベントソースごとに制御が異なる
    - ストリーミング（Kinesis, DynamoDB）：レコードがある限り繰り返す
    - キュー（SQS）：エラーになったメッセージのみ、繰り返し処理
    - 非同期呼び出し（SNS, S3）：最大2回リトライ
  - 失敗時には Destinations 及び DeadLetterQueue によってイベントデータの退避が可能
- ②エラー伝播の回避
  - 疎結合アーキテクチャによるエラー伝播を解消する
    - 非同期呼び出し、コンポーネント（SQS,Kinesis,SNS）の追加
    - 非同期呼び出しの処理結果をDestinationsによって受け取り後続処理を行う（SQSなど）
  - 緊急停止機構を導入し、呼び出しそのものを防ぐ
    - CloudWatchによりエラーをモニタリングし、同時実行数を0に設定する（サーキットブレークパターン）
    - ヘルスチェックに合格したら、同時実行数を元に戻すことで自動復旧する
- ③データ整合性の確保
  - バッチ実行時などリトライにより複数回実行される可能性があるため、関数に冪等性を持たせる
    - 重複処理を排除する（重複して呼び出されても処理をしない）
    - 重複処理を許容する（重複実行が原因で発生するエラーやデータ重複を回避するロジック）
    - At least onceにより正常時にも複数回実行される可能性があるため、冪等性を確保する
  - 複数プロセスが途中で停止した場合、反対処理によりデータ整合性を確保する
    - 在庫データと出荷データ
    - 補償トランザクション（実行順とは逆の順序で取り消し処理を実行する）
    - 愚直に実装するのではなく、ステートマシーン（Step Functions）を活用する
    - 処理1, 処理2, 取り消し処理1, 取り消し処理2を状態遷移させる（Sagaパターン）
    - 取り消し処理がエラーになることも考慮し、最悪はマニュアルでの対応ができるようにする
    - 処理期限が過ぎたデータ（価値のないデータ）の再実行を防ぐ
  - ビジネス要求に沿って各イベントの有効期間を設定することで回復を早期化する

## 【コンテナを有効活用したいあなたへ AWS コンテナサービス入門 2020】32min
- AWSのコンテナサービスの特徴、利用シーンを説明するセッション
- 前提知識の説明
  - アプリケーションはランタイム、コード、ライブラリ、環境設定で構成されている
  - コンテナはランタイム、コード、ライブラリを包含した状態となっている
  - 環境設定はコンテナ実行時にパラメータで渡す
  - Dockerは同一サーバ上のライフサイクル管理が責務であり、複数サーバの管理はスコープ外
  - 手作業でDockerをDocker Pullする場合、非効率かつオペミスが発生する可能性がある
- Amazon ECS
  - API経由で複数サーバにオーケストレーションすることが可能
  - 各種AWSサービスとの高度な連携が可能（Secret,モニタリング,Iac,CI/CD,NW）
  - 「タスク」「サービス」を理解すれば基本的な運用が可能に
- Amazon EKS
  - Kubernetes(K8S)をマネージドで利用可能
  - K8SのメリットであるエコシステムのOSSやツールを利用できる
    - K8Sで動作するものはEKSで動作することが保証されている
    - Prometheus, Grafana, Argo CD Spinnaker, Istio, LINKERD, HELM,,,
  - 各種AWSサービスとの高度な連携が可能（Secret,モニタリング,Iac,CI/CD,NW）
  - 「Pod」「Deployment」「Service」「Job」などの高いリソース表現力
  - EKS APIによりコントロールプレーン、データプレーンがマネージドで管理可能
- Amazon ECR
  - マネージドなプライベートレジストリ
  - 自動的な暗号化、IAM連携によるセキュリティ
  - スケーラブル、高可用性
  - ECS／EKS以外からも利用可能
  - CI/CDの中でのイメージの脆弱性スキャン（CoreOS Clair）が無料で利用可能
- AWS Fargate
  - コンテナネイティブであり、オートスケーリング、コンテナ管理が可能
  - 仮想マシンを意識することなくコンテナの開発に集中できる
  - ECSだけでなく、2019/12月からEKSでもFargateを利用可能（東京RegionもOK）
  - 秒単位での従量課金（2019年/1月に50%値下げ）
  - リザーブドインスタンスやスポットインスタンスなどの選択肢も2019年に追加
- コンテナサービス選定指針
  - Fargate 1st（GPUサポートが必要ならEC2タイプ）
  - マネージドサービスがあるのにコンテナを自作しようとしていないか
  - サーバレス、仮想マシンも含め、適切な基板を選択する
- 数字で見るAWSコンテナサービス
  - クラウド上の全てのコンテナアプリケーションのうち、AWSが80%
  - AWSコンテナサービスの成長度は150%
  - 直近1年間のEKS利用量は10倍に
  - 直近1年間のFargarte利用量は3倍に
  - 1週間あたりのECR Pullされるイメージ数は20億以上

## 【最高の "Kubernetes on AWS" を実現するために】38min
- K8Sの長期運用を前提としたベストプラクティスを説明するセッション
- 思考停止のマルチテナントを見直す
  - 複数サービスを単一のクラスタで実行、サービス開発Tは独自のタイミングでデプロイ
  - メリットが多く、代表的な利用パターンの1つ
    - クラスタ数が最小
    - リソース使用効率が高い
    - クラスタに閉じた世界での設計（クラスタ内DNSを扱える）
    - エコシステムOSSを素直に利用可能
    - 事例が多い
  - このパターンの課題
    - クラスタの責務が肥大化する
    - クラスタ障害の影響範囲が広い
    - ステークホルダが増える ≒ クラスタ管理業務の煩雑化
    - 上記を考慮せずにそれなりに動くものを作れてしまう（あとで困る）
    - 結果、仮想マシン時代の「ペット化」と同じことが起きる
  - クラスタのペット化を避ける
    - 可能な限り自動化（いつでも削除、再作成が可能なクラスタにする）
    - Infrastructure as Code / Immutable Infurastructure
    - クラスタ切り出しや分割を考慮した構築方法の検討が必要
- 複数クラスタの代表的構成パターン
  - AWSリソース（ALB,SQS）を共有しないクラスタ群
    - Pros：クラスタ障害が互いに影響を与えない、クラスタごとにライフサイクル
    - Cons：クラスタ運用コストの増大
    - 独立したクラスタを持つべき
      - 異なる事業ライン
      - 異なる環境(stg,prod)
      - 共通サービス（独自ID基盤）
      - 異なるSLA
      - 実験用（R＆D用）クラスタ
    - クラスタ分割を検討すべき（一段優先度は下がる）
      - 異なるSLO
      - マイクロサービス化し、各サービスチームに強い自律性を与える
      - ステークホルダーが多く、K8Sパッチに数週間を要してしまっている場合
    - AWSアカウントの管理
      - 可能な限りAWSアカウントを分けることを推奨（セキュリティ、クォータetc）
      - AWS OrganizationsやSSOの併用でマルチAWSアカウント管理する（SAML連携）
      - クラスタ群管理用のAWSアカウントにログを集約し、監査に備える
  - AWSリソース（ALB,SQS）を共有するクラスタ群
    - クラスタとAWSリソースの疎結合性実現、Blue／Greenデプロイ
    - 運用構築難易度は高いが、K8S自体の運用容易性は高い
    - Pros：クラスタとAWSリソースの疎結合か、クラスタ責務範囲を狭くできる
    - Cons：構築時に考えることが増える（ビルディングブロックを繋ぐ難しさ）
    - ALBの共有化の難易度が高い（ALB Ingress Controllerが使えない）
    - 解決策
      - ALB, リスナ, ターゲットグループの作成はCloudFormation, Terraformを使う
      - ポート番号でK8S Serviceを用意
      - ALBに加えてNginx Ingress Controllerを使って別クラスタにアクセスする
